<!DOCTYPE html>
<html>

<head>
    <!-- *Recommended WebRTC Shim -->
    <script src="https://webrtchacks.github.io/adapter/adapter-latest.js"></script>
</head>

<body>
    <button id="flip-button">
      <img src="/flip-camera.png" height="32" />
    </button>
    <!-- video containers -->
    <!-- publisher -->
    <div>
        <video id="red5pro-publisher" muted autoplay fullscreen full-width playsinline controls disablePictureInPicture></video>
    </div>

    <!-- Start  -->

    <!-- END -->

    <!-- Red5 Pro SDK -->
    <script src="https://www.red5pro.com/demo/scripts/red5pro-sdk.min.js"></script>
    <!-- Create Pub/Sub -->
    <script>
        var publisher = new red5prosdk.RTCPublisher();

        var token = getCookie("authToken");
        var not_allow = false;
        var front = false;
        // check user login

        if (window.location !== window.parent.location) {
            not_allow = false;
        } else {
            not_allow = true;
        }

        if (not_allow) {
            // window.location.href = "/";
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        function getServerInfo(param) {
            const url_string = window.location;
            const url = new URL(url_string);
            return url.searchParams.get(param);
        }
        document.getElementById("flip-button").onclick = function() {
            console.log(front);
            front = !front;

            publisher.init({
                mediaConstraints: {
                    audio: true,
                    video: {
                        facingMode: front ? "user" : "environment"
                    }
                }
            });
            
        };
        var dwith = window.innerWidth > 0 ? window.innerWidth : screen.width;
        var dheight = window.innerHeight > 0 ? window.innerHeight : screen.width;

        document.getElementById("red5pro-publisher").width = dwith;
        document.getElementById("red5pro-publisher").height = dheight;

        var constraints = {
            video: {
                facingMode: front ? "user" : "environment",
            },
        };

        var streemName = 'live-test-kamal-11';
        const video = document.querySelector('#red5pro-publisher');
        (function(red5prosdk) {
            let broadcastRequest = new Request(
                "https://streammanager.mypremo.com/streammanager/api/4.0/event/live/" +
                streemName +
                "?action=broadcast"
            );

            fetch(broadcastRequest).then(async function(response) {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const connectionParam = await response.json();
                console.log(connectionParam);
                // Create a new instance of the WebRTC publisher.

                // Initialize
                publisher
                    .init({
                        protocol: "wss",
                        port: 443,
                        host: "streammanager.mypremo.com",
                        app: "streammanager",
                        streamName: connectionParam.name,
                        rtcConfiguration: {
                            iceServers: [{
                                urls: "stun:stun2.l.google.com:19302",
                            }, ],
                            iceCandidatePoolSize: 2,
                            bundlePolicy: "max-bundle",
                        }, // See https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/RTCPeerConnection#RTCConfiguration_dictionary
                        connectionParams: {
                            host: connectionParam.serverAddress,
                            app: connectionParam.scope,
                        },
                        streamMode: "live",
                        mediaElementId: "red5pro-publisher",
                        bandwidth: {
                            audio: 56,
                            video: 512,
                        },
                        mediaConstraints: {
                            audio: true,
                            video: {
                                width: {
                                    max: 420,
                                    ideal: 420,
                                    min: 360,
                                },
                                height: {
                                    exact: 640,
                                    // max: 660,
                                    // ideal: 480,
                                    // min: 360
                                },
                                frameRate: {
                                    min: 8,
                                    max: 24,
                                },
                            },
                        },

                        onGetUserMedia: function () {
                            let streamData =  navigator.mediaDevices.getUserMedia({
                                audio: true,
                                video: true
                            })

                            video.addEventListener('pause', (event) => {
                                    console.log(event);
                                    let disableStreamData = streamData.then((r)=>{
                                        //video off ::  r.getVideoTracks().forEach(track => track.enabled = false)
                                        //mute audio::  r.getAudioTracks().forEach(track => track.enabled = false)
                                        r.getTracks().forEach(track => track.enabled = false)
                                    })
                                    return disableStreamData
                            });

                            video.addEventListener('play', (event) => {
                                    console.log(event);
                                    let enableStreamData = streamData.then((r)=>{
                                        // video on :: r.getVideoTracks().forEach(track => track.enabled = true)
                                        // unmute audio:: r.getAudioTracks().forEach(track => track.enabled = true)
                                        r.getTracks().forEach(track => track.enabled = true)
                                    })
                                    return enableStreamData
                            });
                            return streamData
                        }
                    })
                    .then(function() {
                        // Invoke the publish action.
                        return publisher.publish();
                    })
                    .catch(function(error) {
                        // A fault occurred while trying to initialize and publish the stream.
                        console.error(error);
                    });
            });
        })(window.red5prosdk);
    </script>
    <style>
        #red5pro-publisher {
            width: 100vw;
            height: 80vh;
            min-height: 480px;
            max-width: 428px !important;
        }
        
        #flip-button {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            background-color: red;
            z-index: 999999999;
        }
        
        video::-webkit-media-controls-volume-slider {
            display: none;
        }
        
        video::-webkit-media-controls-mute-button {
            display: none;
        }
    </style>
</body>

</html>
