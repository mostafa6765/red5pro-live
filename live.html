<!DOCTYPE html>
<html>

<head>
    <!-- *Recommended WebRTC Shim -->
    <script src="https://webrtchacks.github.io/adapter/adapter-latest.js"></script>
</head>

<body>
    <button id="flip-button">
      change camera mode
    </button>
    <button id="flip-button-2">
        change camera mode env
      </button>
    <!-- video containers -->
    <!-- publisher -->
    <div>
        <video id="red5pro-publisher" muted autoplay fullscreen full-width playsinline controls disablePictureInPicture></video>
    </div>

    <!-- Start  -->

    <!-- END -->

    <!-- Red5 Pro SDK -->
    <script src="https://www.red5pro.com/demo/scripts/red5pro-sdk.min.js"></script>
    <!-- Create Pub/Sub -->
    <script>
        var publisher = new red5prosdk.RTCPublisher();

        function myStream(){
            return publisher.getMediaStream();
        }

        const video = document.querySelector('#red5pro-publisher');

        video.addEventListener('play', (event) => {
            var stream = myStream()
            stream.getTracks().forEach(function (track) {
                track.enabled = true
            });
        });

        video.addEventListener('pause', (event) => {
            var stream = myStream()
            stream.getTracks().forEach(function (track) {
                track.enabled = false
            });
        });

        function unpublish () {
            return new Promise(function (resolve, reject) {
            var publisher = targetPublisher;
            publisher.unpublish()
                .then(function () {
                resolve();
                })
                .catch(function (error) {
                var jsonError = typeof error === 'string' ? error : JSON.stringify(error, 2, null);
                reject(error);
                });
            });
        }

        var token = getCookie("authToken");
        var front = false;
        // check user login

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        function getServerInfo(param) {
            const url_string = window.location;
            const url = new URL(url_string);
            return url.searchParams.get(param);
        }

        var dwith = window.innerWidth > 0 ? window.innerWidth : screen.width;
        var dheight = window.innerHeight > 0 ? window.innerHeight : screen.width;

        document.getElementById("red5pro-publisher").width = dwith;
        document.getElementById("red5pro-publisher").height = dheight;

        var streemName = 'live-test-kamal-11';

            let red5Init = async (connectionParam, facingMode = 'user') => {
                await publisher.init({
                    protocol: "wss",
                    port: 443,
                    host: "streammanager.mypremo.com",
                    app: "streammanager",
                    streamName: connectionParam.name,
                    rtcConfiguration: {
                        iceServers: [{
                            urls: "stun:stun2.l.google.com:19302",
                        },],
                        iceCandidatePoolSize: 2,
                        bundlePolicy: "max-bundle",
                    }, // See https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/RTCPeerConnection#RTCConfiguration_dictionary
                    connectionParams: {
                        host: connectionParam.serverAddress,
                        app: connectionParam.scope,
                    },
                    streamMode: "live",
                    mediaElementId: "red5pro-publisher",
                    bandwidth: {
                        audio: 56,
                        video: 512,
                    },
                    onGetUserMedia: function () {

                        let streamData = navigator.mediaDevices.getUserMedia({
                            audio: true,
                            video: {
                                facingMode: facingMode
                            }
                        })
                        return streamData
                    }
                })
                await publisher.publish()
                publisher.on('*', handlePublisherEvent)
                console.log(publisher)
            }
        
        function handlePublisherEvent(event) {
            // The name of the event:
             const { type } = event
            console.log(type)
            // The dispatching publisher instance:
            const { publisher } = event
            // Optional data releated to the event (not available on all events):
            const { data } = event
        }

        function start(red5prosdk,facingMode) {
            let broadcastRequest = new Request(
                "https://streammanager.mypremo.com/streammanager/api/4.0/event/live/" +
                streemName +
                "?action=broadcast"
            );
            fetch(broadcastRequest).then(async function(response) {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const connectionParam = await response.json();
                console.log(connectionParam);
                // Create a new instance of the WebRTC publisher.
                red5Init(connectionParam,facingMode)    
            });
        };
        start(window.red5prosdk,'user')

        l = document.getElementById('flip-button')
        
        l.addEventListener('click', (event)=>{
            video.srcObject = null
            publisher.unpublish()
            setTimeout(() => {
                start(window.red5prosdk, 'environment')
            }, 1000);
        })
        lp = document.getElementById('flip-button-2')
        lp.addEventListener('click', (event)=>{
            video.srcObject = null
            publisher.unpublish()
            setTimeout(() => {
                start(window.red5prosdk, 'user')
            }, 1000);
        })
    </script>
    <style>
        #red5pro-publisher {
            width: 100vw;
            height: 80vh;
            min-height: 480px;
            max-width: 428px !important;
        }
        
        #flip-button {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            background-color: red;
            z-index: 999999999;
        }
        
        video::-webkit-media-controls-volume-slider {
            display: none;
        }
        
        video::-webkit-media-controls-mute-button {
            display: none;
        }
    </style>
</body>

</html>
